services:
  changedetection:
    image: ghcr.io/dgtlmoon/changedetection.io:latest
    container_name: changedetection
    hostname: changedetection
    restart: unless-stopped
    ports:
      - "${BIND_IP}:${CHANGEDETECTION_PORT:-5091}:5000"
    environment:
      - PLAYWRIGHT_DRIVER_URL=${CHANGEDETECTION_PLAYWRIGHT_URL:-ws://browser-sockpuppet-chrome:3000}
      - BASE_URL=${CHANGEDETECTION_BASE_URL:-http://localhost:5000}
      - TZ=${TZ:-Asia/Jakarta}
      - FETCH_WORKERS=${CHANGEDETECTION_FETCH_WORKERS:-10}
    volumes:
      - changedetection_data:/datastore
    depends_on:
      browser-sockpuppet-chrome:
        condition: service_started
    networks:
      - homelab
    deploy:
      resources:
        limits:
          cpus: "${CHANGEDETECTION_CPU_LIMIT:-0.5}"
          memory: ${CHANGEDETECTION_MEMORY_LIMIT:-512M}

  browser-sockpuppet-chrome:
    image: dgtlmoon/sockpuppetbrowser:latest
    container_name: browser-sockpuppet-chrome
    hostname: browser-sockpuppet-chrome
    restart: unless-stopped
    ports:
      - "${BIND_IP}:${SOCKPUPPET_PORT:-3097}:3000"
    cap_add:
      - SYS_ADMIN
    environment:
      - SCREEN_WIDTH=${SOCKPUPPET_SCREEN_WIDTH:-1920}
      - SCREEN_HEIGHT=${SOCKPUPPET_SCREEN_HEIGHT:-1024}
      - SCREEN_DEPTH=${SOCKPUPPET_SCREEN_DEPTH:-16}
      - MAX_CONCURRENT_CHROME_PROCESSES=${SOCKPUPPET_MAX_CONCURRENT_CHROME_PROCESSES:-10}
    networks:
      - homelab
    deploy:
      resources:
        limits:
          cpus: "${SOCKPUPPETBROWSER_CPU_LIMIT:-1}"
          memory: ${SOCKPUPPETBROWSER_MEMORY_LIMIT:-1G}

networks:
  homelab:
    external: true

volumes:
  changedetection_data:
